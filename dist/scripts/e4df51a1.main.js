var Ma={config:{alphabet:"abcdefghijklmnopqrstuvwxyz",baseUrl:"http://gateway.marvel.com:80/v1/public/",key:"587705ba5ff4d0cabadddbbbe5cb3545",limit:"100",imgFormat:"standard_xlarge",charDataKeys:["name","description","id",["thumbnail","path"],["thumbnail","extension"],["stories","available"],["series","collectionURI"]]},data:{characters:[],series:[]},ajaxCalls:[],ajaxSeriesCalls:[],apiCall:function(a,b,c){var d={url:a,cache:!0,dataType:"json",success:function(a){b(a)}};return c&&(d.dataFilter=c),$.ajax(d)},dataFilter:function(a,b){if("json"===b){var c=JSON.parse(a),d=c.data.results;d=$.grep(d,function(a){return a.thumbnail&&a.thumbnail.path.match("available")?!1:!0}),c.data.results=d}return JSON.stringify(c)},generateUrl:function(a,b,c){var d=Ma.config.baseUrl+a+"limit="+Ma.config.limit+"&apikey="+Ma.config.key+"&"+b;return c?d+c:d},parseCharData:function(a){var b=a.data.results,c=Ma.config.charDataKeys;b.forEach(function(a){var b={};c.forEach(function(c){Array.isArray(c)&&a[c[0]]?b[c[0]+c[1]]=a[c[0]][c[1]]:b[c]=a[c]}),b.value=a.stories.available,Ma.data.characters.push(b)})},bindBubbleData:function(a){var b=$(".character-bubbles").height(),c=d3.format(",d"),d=(d3.scale.category20c(),d3.layout.pack().sort(null).size([b,b]).padding(1.5)),e=d3.select(".character-bubbles").append("svg").attr("width",b).attr("height",b).attr("class","bubble"),f=e.append("svg:defs"),g=e.selectAll(".node").data(d.nodes(a).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("data-char-id",function(a){return a.id}).attr("data-toggle","modal").attr("data-target",".bs-example-modal-lg").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});g.append("title").text(function(a){return a.name+":"+c(a.storiesavailable)}),g.append("circle").attr("r",function(a){return a.r}).style("fill",function(a){return Ma.addPatternsToBubble(f,a)}),d3.select(self.frameElement).style("height",b+"px")},addPatternsToBubble:function(a,b){return a.append("pattern").attr("id",b.id).attr("width","100%").attr("height","100%").append("image").attr("xlink:href",b.thumbnailpath+"/"+Ma.config.imgFormat+"."+b.thumbnailextension).attr("x",0).attr("y",0).attr("width",2*b.r).attr("height",2*b.r),"url(/#"+b.id+")"},init:function(){for(var a=Ma.config.alphabet.split(""),b=0;b<a.length;b++){var c=Ma.generateUrl("characters?","nameStartsWith="+a[b]),d=Ma.apiCall(c,Ma.parseCharData,Ma.dataFilter);Ma.ajaxCalls.push(d)}var e=Ma.generateUrl("characters?","nameStartsWith=s","&offset=100");Ma.ajaxCalls.push(Ma.apiCall(e,Ma.parseCharData,Ma.dataFilter)),$.when.apply(Ma,Ma.ajaxCalls).done(function(){console.log(Ma.data.characters),$(".character-bubbles").removeClass("loading"),Ma.bindBubbleData({name:"marvel",children:Ma.data.characters}),Ma.seriesEventHandler()})},callSeries:function(a,b,c,d){return $.ajax({url:a+"&offset="+100*c,type:"GET",success:function(a){console.log(a),console.log("total: "+b),Ma.parseSeriesDataHelper(a,d)}})},parseSeriesDataHelper:function(a,b){var c=a.data.results;c.forEach(function(a){var c=a.title,d=a.id,e=a.startYear;e>0&&Ma.data.series[b].push({seriesTitle:c,seriesId:d,seriesStartYear:e})}),console.log(Ma.data.series)},parseSeriesData:function(a){var b=Ma.countProp(Ma.data.series[a]);return b.sort(function(a,b){return a.date-b.date}),b},countProp:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=b.every(function(a){return a.date!=d.seriesStartYear});e?b.push({date:d.seriesStartYear.toString(),close:1}):b.forEach(function(a){a.date==d.seriesStartYear&&(a.close+=1)})}return b},bindLineChart:function(a,b){var c={top:20,right:20,bottom:30,left:50},d=$(".modal-content").width()-c.left-c.right,e=400,f=d3.time.format("%Y").parse,g=d3.time.scale().range([0,d]),h=d3.scale.linear().range([e,0]),i=d3.svg.axis().scale(g).orient("bottom"),j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.date)}).y(function(a){return h(a.close)}),l=d3.select(b).append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")");a.forEach(function(a){a.date=f(a.date),a.close=+a.close}),g.domain(d3.extent(a,function(a){return console.log(a),a.date})),h.domain(d3.extent(a,function(a){return a.close})),console.log(d),console.log(e),l.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Number of Series"),l.append("path").datum(a).attr("class","line").attr("d",k)},seriesEventHandler:function(){$("svg").on("click","g",function(){var a,b=$(this).data("char-id"),c=Ma.data.characters;console.log(b),$(".modal-content").html(b);for(var d=0;d<c.length;d++)c[d].id==b&&(a=c[d]);var e=a.seriescollectionURI,f=e+"?apikey="+Ma.config.key+"&limit=100";console.log(f);var g;$.ajax({url:f,dataType:"json",type:"GET",success:function(a,b){console.log(a),g=a.data.total,Ma.data.series[b]=[],console.log(g),Ma.parseSeriesDataHelper(a,b);for(var c=1;g/100>c;c++)Ma.ajaxSeriesCalls.push(Ma.callSeries(f,g,c,b));$.when.apply(this,Ma.ajaxSeriesCalls).done(function(){var a=Ma.parseSeriesData(b);Ma.bindLineChart(a,".modal-content")})}})})}};Ma.init();